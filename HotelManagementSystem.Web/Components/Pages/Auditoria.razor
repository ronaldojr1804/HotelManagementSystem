@page "/auditoria"
@attribute [Authorize(Roles = "Admin")]
@inject AuditService AuditService
@rendermode InteractiveServer

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Log de Auditoria</h1>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
        <!-- Date Range -->
        <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Período</label>
            <div class="flex items-center space-x-2">
                <input type="date" @bind="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                <span class="text-gray-400">-</span>
                <input type="date" @bind="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
            </div>
        </div>

        <!-- User Filter -->
        <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Usuário</label>
            <input type="text" @bind="userFilter" placeholder="Nome do usuário..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
        </div>

        <!-- Action Filter -->
        <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Ação</label>
            <select @bind="actionFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <option value="">Todas</option>
                <option value="Create">Create</option>
                <option value="Update">Update</option>
                <option value="Delete">Delete</option>
                <option value="Login">Login</option>
            </select>
        </div>

        <!-- Search -->
        <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Detalhes</label>
            <div class="flex space-x-2">
                <input type="text" @bind="searchFilter" placeholder="Buscar nos detalhes..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                <button @onclick="ApplyFilters" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                    Filtrar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold tracking-wider">
                    <th class="px-6 py-4">Data/Hora</th>
                    <th class="px-6 py-4">Usuário</th>
                    <th class="px-6 py-4">Ação</th>
                    <th class="px-6 py-4">Tabela</th>
                    <th class="px-6 py-4">Detalhes</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                @if (logs == null)
                {
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Carregando...</td></tr>
                }
                else if (!logs.Any())
                {
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Nenhum registro encontrado.</td></tr>
                }
                else
                {
                    @foreach (var log in logs)
                    {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 text-gray-600 text-sm">@log.DataHora.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            <td class="px-6 py-4 font-medium text-gray-800">@log.UsuarioNome</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @GetActionColor(log.Acao)">
                                    @log.Acao
                                </span>
                            </td>
                            <td class="px-6 py-4 text-gray-600 text-sm">@log.Tabela</td>
                            <td class="px-6 py-4 text-gray-600 text-sm max-w-xs truncate" title="@log.Detalhes">@log.Detalhes</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="px-6 py-4 border-t border-gray-100 flex justify-between items-center bg-gray-50">
        <span class="text-sm text-gray-600">
            Mostrando @((currentPage - 1) * pageSize + 1) a @Math.Min(currentPage * pageSize, totalCount) de @totalCount registros
        </span>
        <div class="flex space-x-2">
            <button @onclick="PreviousPage" disabled="@(currentPage == 1)" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                Anterior
            </button>
            <button @onclick="NextPage" disabled="@(currentPage * pageSize >= totalCount)" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                Próxima
            </button>
        </div>
    </div>
</div>

@code {
    private List<AuditLog>? logs;
    private int totalCount;
    private int currentPage = 1;
    private int pageSize = 20;

    private DateTime? startDate;
    private DateTime? endDate;
    private string userFilter = "";
    private string actionFilter = "";
    private string searchFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        var result = await AuditService.GetLogsAsync(currentPage, pageSize, userFilter, actionFilter, null, startDate, endDate, searchFilter);
        logs = result.Logs;
        totalCount = result.TotalCount;
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadLogs();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadLogs();
        }
    }

    private async Task NextPage()
    {
        if (currentPage * pageSize < totalCount)
        {
            currentPage++;
            await LoadLogs();
        }
    }

    private string GetActionColor(string action)
    {
        return action switch
        {
            "Create" => "bg-green-100 text-green-800",
            "Update" => "bg-blue-100 text-blue-800",
            "Delete" => "bg-red-100 text-red-800",
            "Login" => "bg-purple-100 text-purple-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }
}
