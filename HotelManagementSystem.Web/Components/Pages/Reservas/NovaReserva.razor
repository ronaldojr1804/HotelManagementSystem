@page "/reservas/nova"
@attribute [Authorize]
@inject ReservationService ReservationService
@inject GuestService GuestService
@inject RoomService RoomService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@using HotelManagementSystem.Web.Components.Shared

<div class="w-full px-6 pb-10">
    <div class="flex items-center mb-6">
        <a href="reservas" class="mr-4 text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Nova Reserva</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Form Area -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <EditForm Model="newReservation" OnValidSubmit="CreateReservation">
                <DataAnnotationsValidator />
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Hóspede Principal -->
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hóspede Principal</label>
                        <div class="flex items-center space-x-2">
                            <div class="flex-1 p-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 min-h-[42px] flex items-center">
                                @if (selectedGuest != null)
                                {
                                    <span>@selectedGuest.Nome (@selectedGuest.CPF)</span>
                                }
                                else
                                {
                                    <span class="text-gray-400 italic">Nenhum selecionado</span>
                                }
                            </div>
                            <button type="button" @onclick="() => OpenSearch(SearchModal.SearchType.Guest)" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                        @if (showGuestError)
                        {
                            <p class="text-red-500 text-xs mt-1">Selecione um hóspede.</p>
                        }
                    </div>
                    
                    <!-- Quarto -->
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quarto</label>
                        <div class="flex items-center space-x-2">
                            <div class="flex-1 p-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 min-h-[42px] flex items-center">
                                @if (selectedRoom != null)
                                {
                                    <span>Quarto @selectedRoom.Numero - @selectedRoom.Tipo (R$ @selectedRoom.PrecoBase.ToString("F2"))</span>
                                }
                                else
                                {
                                    <span class="text-gray-400 italic">Nenhum selecionado</span>
                                }
                            </div>
                            <button type="button" @onclick="() => OpenSearch(SearchModal.SearchType.Room)" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                        @if (showRoomError)
                        {
                            <p class="text-red-500 text-xs mt-1">Selecione um quarto.</p>
                        }
                    </div>
                    
                    <!-- Datas -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data de Entrada (14:00)</label>
                        <InputDate @bind-Value="newReservation.DataEntrada" @bind-Value:after="CheckAvailability" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data de Saída (12:00)</label>
                        <InputDate @bind-Value="newReservation.DataSaida" @bind-Value:after="CheckAvailability" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" />
                    </div>

                    <!-- Quantidade de Pessoas -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade de Pessoas</label>
                        <InputNumber @bind-Value="newReservation.QuantidadePessoas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" min="1" />
                    </div>

                    <!-- Forma de Pagamento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                        <InputSelect @bind-Value="newReservation.FormaPagamento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Pix">Pix</option>
                        </InputSelect>
                    </div>
                </div>

                @if (isCheckingAvailability)
                {
                    <div class="mb-6 p-4 bg-blue-50 text-blue-700 rounded-lg flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-700 mr-2"></div>
                        Verificando disponibilidade...
                    </div>
                }
                else if (!isRoomAvailable && newReservation.QuartoId > 0)
                {
                    <div class="mb-6 p-4 bg-red-50 text-red-700 rounded-lg border border-red-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>O quarto selecionado não está disponível neste período.</span>
                    </div>
                }

                <!-- Hóspedes Secundários -->
                <div class="border-t border-gray-200 pt-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Hóspedes Secundários</h3>
                        <button type="button" @onclick="() => OpenSearch(SearchModal.SearchType.Guest, true)" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Adicionar Hóspede
                        </button>
                    </div>
                    
                    @if (newReservation.HospedesSecundarios.Any())
                    {
                        <div class="space-y-2">
                            @foreach (var guest in newReservation.HospedesSecundarios)
                            {
                                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                    <div>
                                        <span class="font-medium text-gray-800">@guest.Nome</span>
                                        <span class="text-sm text-gray-500 ml-2">(@guest.CPF)</span>
                                    </div>
                                    <button type="button" @onclick="() => RemoveSecondaryGuest(guest)" class="text-red-500 hover:text-red-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-sm text-gray-500 italic">Nenhum hóspede secundário adicionado.</p>
                    }
                </div>
                
                <div class="flex justify-end space-x-3">
                    <a href="reservas" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors font-medium text-center">Cancelar</a>
                    <button type="submit" disabled="@(!isRoomAvailable)" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Criar Reserva</button>
                </div>
            </EditForm>
        </div>

        <!-- Summary Area -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 sticky top-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Resumo da Reserva</h3>
                
                <div class="space-y-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Diárias</span>
                        <span class="font-medium text-gray-800">@((newReservation.DataSaida - newReservation.DataEntrada).TotalDays) dias</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Valor Diária</span>
                        <span class="font-medium text-gray-800">
                            @if (selectedRoom != null)
                            {
                                @selectedRoom.PrecoBase.ToString("C")
                            }
                            else
                            {
                                <span class="text-gray-400">-</span>
                            }
                        </span>
                    </div>

                    <div class="border-t border-gray-100 pt-4 mt-4">
                        <div class="flex justify-between items-center">
                            <span class="text-base font-semibold text-gray-800">Total Estimado</span>
                            <span class="text-xl font-bold text-blue-600">
                                @if (selectedRoom != null)
                                {
                                    @((selectedRoom.PrecoBase * (decimal)(newReservation.DataSaida - newReservation.DataEntrada).TotalDays).ToString("C"))
                                }
                                else
                                {
                                    <span class="text-gray-400">-</span>
                                }
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-right">Não inclui consumos extras.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<SearchModal IsVisible="isSearchVisible" 
             Type="searchType" 
             StartDate="@(searchType == SearchModal.SearchType.Room ? newReservation.DataEntrada : null)"
             EndDate="@(searchType == SearchModal.SearchType.Room ? newReservation.DataSaida : null)"
             OnGuestSelected="HandleGuestSelected" 
             OnRoomSelected="HandleRoomSelected" 
             OnClose="CloseSearch" />

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }

    private Reserva newReservation = new() { DataEntrada = DateTime.Today, DataSaida = DateTime.Today.AddDays(1) };
    private Hospede? selectedGuest;
    private Quarto? selectedRoom;
    
    private bool isSearchVisible = false;
    private SearchModal.SearchType searchType;
    private bool isSelectingSecondary = false;
    
    private bool showGuestError = false;
    private bool showRoomError = false;
    
    private bool isRoomAvailable = true;
    private bool isCheckingAvailability = false;

    private void OpenSearch(SearchModal.SearchType type, bool secondary = false)
    {
        searchType = type;
        isSelectingSecondary = secondary;
        isSearchVisible = true;
    }

    private void CloseSearch()
    {
        isSearchVisible = false;
    }

    private void HandleGuestSelected(Hospede guest)
    {
        if (isSelectingSecondary)
        {
            if (guest.Id != newReservation.HospedeId && !newReservation.HospedesSecundarios.Any(g => g.Id == guest.Id))
            {
                newReservation.HospedesSecundarios.Add(guest);
            }
        }
        else
        {
            selectedGuest = guest;
            newReservation.HospedeId = guest.Id;
            showGuestError = false;
        }
    }

    private async Task HandleRoomSelected(Quarto room)
    {
        selectedRoom = room;
        newReservation.QuartoId = room.Id;
        showRoomError = false;
        await CheckAvailability();
    }

    private void RemoveSecondaryGuest(Hospede guest)
    {
        newReservation.HospedesSecundarios.Remove(guest);
    }
    
    private async Task CheckAvailability()
    {
        if (newReservation.QuartoId == 0) return;
        
        isCheckingAvailability = true;
        isRoomAvailable = await ReservationService.IsRoomAvailableAsync(newReservation.QuartoId, newReservation.DataEntrada, newReservation.DataSaida);
        isCheckingAvailability = false;
    }

    private async Task CreateReservation()
    {
        showGuestError = newReservation.HospedeId == 0;
        showRoomError = newReservation.QuartoId == 0;

        if (showGuestError || showRoomError)
        {
            return;
        }
        
        await CheckAvailability();
        if (!isRoomAvailable)
        {
            return;
        }

        if (authenticationStateTask != null)
        {
            var authState = await authenticationStateTask;
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                // In a real app with Identity, use user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                newReservation.UsuarioCriacaoId = user.Identity.Name; 
            }
        }

        await ReservationService.CreateReservationAsync(newReservation);
        Navigation.NavigateTo("reservas");
    }
}
