@page "/reservas/voucher/{Id:int}"
@layout HotelManagementSystem.Web.Components.Layout.PrintLayout
@attribute [Authorize]
@inject ReservationService ReservationService
@inject ConfigurationService ConfigurationService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

@if (reservation == null || config == null)
{
    <div class="flex justify-center items-center h-64">
        <p class="text-gray-500">Carregando voucher...</p>
    </div>
}
else
{
    <div class="max-w-3xl mx-auto border border-gray-200 p-8 rounded-lg shadow-sm print:shadow-none print:border-0">
        <!-- Header -->
        <div class="text-center border-b border-gray-200 pb-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 uppercase tracking-wide">Comprovante de Reserva</h1>
            <p class="text-gray-500 mt-2">@config.NomeHotel</p>
            <p class="text-sm text-gray-400">CNPJ: @config.CNPJ</p>
            <p class="text-sm text-gray-400">@config.Endereco</p>
            <p class="text-sm text-gray-400">Emitido em: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
        </div>

        <!-- Reservation Details -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            <div>
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Hóspede</h3>
                <p class="text-lg font-semibold text-gray-800">@reservation.Hospede?.Nome</p>
                <p class="text-sm text-gray-600">CPF: @reservation.Hospede?.CPF</p>
            </div>
            <div class="text-right">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Reserva #</h3>
                <p class="text-lg font-semibold text-gray-800">@reservation.Id</p>
                <div class="mt-2">
                    <span class="px-2 py-1 rounded text-xs font-bold border @GetStatusClass()">
                        @GetStatusText()
                    </span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-8 mb-8 bg-gray-50 p-6 rounded-lg print:bg-transparent print:p-0">
            <div>
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Check-in</h3>
                <p class="text-lg font-semibold text-gray-800">@reservation.DataEntrada.ToShortDateString()</p>
                <p class="text-sm text-gray-600">14:00</p>
                @if (reservation.DataRealCheckIn.HasValue)
                {
                    <p class="text-xs text-green-600 mt-1 font-bold">Realizado: @reservation.DataRealCheckIn.Value.ToString("dd/MM HH:mm")</p>
                }
            </div>
            <div class="text-right">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Check-out</h3>
                <p class="text-lg font-semibold text-gray-800">@reservation.DataSaida.ToShortDateString()</p>
                <p class="text-sm text-gray-600">12:00</p>
                @if (reservation.DataCheckOut.HasValue)
                {
                    <p class="text-xs text-blue-600 mt-1 font-bold">Realizado: @reservation.DataCheckOut.Value.ToString("dd/MM HH:mm")</p>
                }
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Detalhes do Quarto</h3>
            <p class="text-gray-800">Quarto @reservation.Quarto?.Numero - @reservation.Quarto?.Tipo</p>
        </div>

        <!-- Financials -->
        <div class="mb-8">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-4 border-b pb-2">Extrato Financeiro</h3>
            <table class="w-full text-sm mb-4">
                <thead>
                    <tr class="text-gray-500 text-left">
                        <th class="py-2">Descrição</th>
                        <th class="py-2 text-right">Valor</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr>
                        <td class="py-2">Diárias (@((reservation.DataSaida - reservation.DataEntrada).Days) dias x @reservation.ValorDiariaNoMomento.ToString("C"))</td>
                        <td class="py-2 text-right">@reservation.TotalDiarias.ToString("C")</td>
                    </tr>
                    @foreach (var item in reservation.Consumos)
                    {
                        <tr>
                            <td class="py-2">@item.Produto?.Nome (x@item.Quantidade)</td>
                            <td class="py-2 text-right">@item.Total.ToString("C")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="font-bold text-lg text-gray-800 border-t border-gray-300">
                        <td class="py-4">Total Geral</td>
                        <td class="py-4 text-right">@reservation.TotalGeral.ToString("C")</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Footer -->
        <div class="text-center text-xs text-gray-400 mt-12 print:mt-24">
            <p>Obrigado pela preferência!</p>
            <p>@config.NomeHotel - Contato: @config.Contato</p>
        </div>
        
        <!-- Print Button (Hidden on Print) -->
        <div class="mt-8 text-center print:hidden">
            <button @onclick="Print" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow transition duration-200">
                Imprimir Agora
            </button>
            <button @onclick="Close" class="ml-4 text-gray-500 hover:text-gray-700 underline">
                Fechar
            </button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Reserva? reservation;
    private HotelConfiguration? config;

    protected override async Task OnInitializedAsync()
    {
        reservation = await ReservationService.GetReservationAsync(Id);
        config = await ConfigurationService.GetConfigurationAsync();
    }



    private async Task Print()
    {
        await JSRuntime.InvokeVoidAsync("print");
    }

    private async Task Close()
    {
        await JSRuntime.InvokeVoidAsync("window.close");
    }

    private string GetStatusText()
    {
        if (reservation.Cancelada) return "CANCELADA";
        if (reservation.DataCheckOut.HasValue) return "FINALIZADA";
        if (reservation.DataEntrada <= DateTime.Today && reservation.DataSaida >= DateTime.Today) return "ATIVA";
        if (reservation.DataEntrada > DateTime.Today) return "CONFIRMADA";
        return "ATRASADA"; // Or Pendente
    }

    private string GetStatusClass()
    {
        if (reservation.Cancelada) return "border-red-200 text-red-600 bg-red-50";
        if (reservation.DataCheckOut.HasValue) return "border-gray-200 text-gray-600 bg-gray-50";
        if (reservation.DataEntrada <= DateTime.Today && reservation.DataSaida >= DateTime.Today) return "border-green-200 text-green-600 bg-green-50";
        if (reservation.DataEntrada > DateTime.Today) return "border-blue-200 text-blue-600 bg-blue-50";
        return "border-yellow-200 text-yellow-600 bg-yellow-50";
    }
}
